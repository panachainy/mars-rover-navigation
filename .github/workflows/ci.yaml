name: CI/CD Pipeline
on:
    push:
        branches: [ main, develop ]
    pull_request:
        branches: [ main ]

env:
  GO_VERSION: '1.24.2'

jobs:
    test:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Install dependencies
              run: go mod tidy

            - name: Run unit tests
              run: |
                go test ./... -v

            - name: Run integration tests
              run: |
                go test -tags=integration ./... -v

            - name: Run tests with coverage
              run: |
                go test -race -covermode=atomic -coverprofile=covprofile.out ./...
                go test -race -covermode=atomic -coverprofile=covprofile-integration.out -tags=integration ./...

            - name: Upload coverage reports to Codecov
              uses: codecov/codecov-action@v5
              with:
                files: ./covprofile.out,./covprofile-integration.out
                fail_ci_if_error: false
                token: ${{ secrets.CODECOV_TOKEN }}

    ## Have some issue for this
    # security-scan:
    #     runs-on: ubuntu-latest
    #     steps:
    #         - uses: actions/checkout@v4

    #         - name: Set up Go
    #           uses: actions/setup-go@v5
    #           with:
    #               go-version: ${{ env.GO_VERSION }}

    #         - name: Run Gosec Security Scanner
    #           uses: securego/gosec@master
    #           with:
    #             args: '-no-fail -fmt sarif -out results.sarif ./...'

    #         - name: Upload SARIF file
    #           uses: github/codeql-action/upload-sarif@v3
    #           with:
    #             # Path to SARIF file relative to the root of the repository
    #             sarif_file: results.sarif
